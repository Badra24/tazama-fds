services:
  # Infrastructure Services
  nats:
    image: nats:2.10.7-alpine
    container_name: tazama-nats
    ports:
      - "4222:4222"
      - "8222:8222"
      - "6222:6222"
    command: "-js -m 8222"
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:8222/healthz" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - tazama-network

  postgres:
    image: postgres:15-alpine
    container_name: tazama-postgres
    environment:
      POSTGRES_DB: tazama
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5433:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-db:/docker-entrypoint-initdb.d
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - tazama-network

  valkey:
    image: valkey/valkey:7.2.5-alpine
    container_name: tazama-valkey
    ports:
      - "6380:6379"
    healthcheck:
      test: [ "CMD", "valkey-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - tazama-network

  # Core Services
  admin-service:
    build:
      context: ./services/admin-service
      dockerfile: Dockerfile
      args:
        GH_TOKEN: ${GH_TOKEN}
    container_name: tazama-admin-service
    environment:
      - CORS_POLICY=demo
      - NODE_ENV=production
      - FUNCTION_NAME=admin-service
      - PORT=3100
      - MAX_CPU=1
      # Database Configuration
      - CONFIGURATION_DATABASE=configuration
      - CONFIGURATION_DATABASE_HOST=tazama-postgres
      - CONFIGURATION_DATABASE_PORT=5432
      - CONFIGURATION_DATABASE_USER=postgres
      - CONFIGURATION_DATABASE_PASSWORD=postgres
      - EVENT_HISTORY_DATABASE=event_history
      - EVENT_HISTORY_DATABASE_HOST=tazama-postgres
      - EVENT_HISTORY_DATABASE_PORT=5432
      - EVENT_HISTORY_DATABASE_USER=postgres
      - EVENT_HISTORY_DATABASE_PASSWORD=postgres
      - EVALUATION_DATABASE=evaluation
      - EVALUATION_DATABASE_HOST=tazama-postgres
      - EVALUATION_DATABASE_PORT=5432
      - EVALUATION_DATABASE_USER=postgres
      - EVALUATION_DATABASE_PASSWORD=postgres
      # Redis
      - REDIS_DATABASE=0
      - REDIS_SERVERS=[{"host":"tazama-valkey","port":6379}]
      - REDIS_IS_CLUSTER=false
      - REDIS_AUTH=none
      - DISTRIBUTED_CACHETTL=300
      - DISTRIBUTED_CACHE_ENABLED=true
      # Auth
      - AUTHENTICATED=false
      - SIDECAR_HOST=0.0.0.0:5000
    ports:
      - "3100:3100"
    depends_on:
      - postgres
      - nats
      - valkey
    networks:
      - tazama-network

  tms-service:
    build:
      context: ./services/tms-service
      dockerfile: Dockerfile
      args:
        GH_TOKEN: ${GH_TOKEN}
    container_name: tazama-tms
    environment:
      - CORS_POLICY=demo
      - FUNCTION_NAME=tms-service
      - NODE_ENV=production
      - PORT=3000
      - MAX_CPU=1
      - APM_ACTIVE=false
      - APM_SERVICE_NAME=tms-service
      # Database
      - RAW_HISTORY_DATABASE=raw_history
      - RAW_HISTORY_DATABASE_HOST=tazama-postgres
      - RAW_HISTORY_DATABASE_PORT=5432
      - RAW_HISTORY_DATABASE_USER=postgres
      - RAW_HISTORY_DATABASE_PASSWORD=postgres
      - CONFIGURATION_DATABASE=configuration
      - CONFIGURATION_DATABASE_HOST=tazama-postgres
      - CONFIGURATION_DATABASE_PORT=5432
      - CONFIGURATION_DATABASE_USER=postgres
      - CONFIGURATION_DATABASE_PASSWORD=postgres
      - EVENT_HISTORY_DATABASE=event_history
      - EVENT_HISTORY_DATABASE_HOST=tazama-postgres
      - EVENT_HISTORY_DATABASE_PORT=5432
      - EVENT_HISTORY_DATABASE_USER=postgres
      - EVENT_HISTORY_DATABASE_PASSWORD=postgres
      # Redis
      - REDIS_DATABASE=0
      - REDIS_SERVERS=[{"host":"tazama-valkey","port":6379}]
      - REDIS_IS_CLUSTER=false
      - REDIS_AUTH=none
      - DISTRIBUTED_CACHETTL=300
      - DISTRIBUTED_CACHE_ENABLED=true
      # NATS
      - STARTUP_TYPE=nats
      - SERVER_URL=tazama-nats:4222
      - PRODUCER_STREAM=event-director
      - ACK_POLICY=Explicit
      - PRODUCER_STORAGE=File
      - PRODUCER_RETENTION_POLICY=Workqueue
      - SIDECAR_HOST=0.0.0.0:5000
    ports:
      - "3000:3000"
    depends_on:
      - postgres
      - nats
      - valkey
    networks:
      - tazama-network

  event-director:
    build:
      context: ./services/event-director
      dockerfile: Dockerfile
      args:
        GH_TOKEN: ${GH_TOKEN}
    container_name: tazama-event-director
    environment:
      - FUNCTION_NAME=event-director
      - NODE_ENV=production
      - MAX_CPU=1
      - APM_ACTIVE=false
      - APM_SERVICE_NAME=event-director
      # Database
      - CONFIGURATION_DATABASE=configuration
      - CONFIGURATION_DATABASE_HOST=tazama-postgres
      - CONFIGURATION_DATABASE_PORT=5432
      - CONFIGURATION_DATABASE_USER=postgres
      - CONFIGURATION_DATABASE_PASSWORD=postgres
      # Redis
      - REDIS_DATABASE=0
      - REDIS_SERVERS=[{"host":"tazama-valkey","port":6379}]
      - REDIS_IS_CLUSTER=false
      - REDIS_AUTH=none
      - DISTRIBUTED_CACHETTL=300
      - DISTRIBUTED_CACHE_ENABLED=true
      # NATS
      - STARTUP_TYPE=nats
      - SERVER_URL=tazama-nats:4222
      - PRODUCER_STREAM=rule-processor
      - CONSUMER_STREAM=event-director
      - ACK_POLICY=Explicit
      - PRODUCER_STORAGE=File
      - PRODUCER_RETENTION_POLICY=Workqueue
      - SIDECAR_HOST=0.0.0.0:5000
    depends_on:
      - postgres
      - nats
      - valkey
    networks:
      - tazama-network

  rule-901:
    build:
      context: ./services/rule-executer
      dockerfile: Dockerfile
      args:
        GH_TOKEN: ${GH_TOKEN}
        RULE_NAME: "901"
        RULE_VERSION: "1.0.0"
    container_name: tazama-rule-901
    environment:
      - FUNCTION_NAME=rule-executer
      - RULE_NAME=901
      - RULE_VERSION=1.0.0
      - NODE_ENV=production
      - MAX_CPU=1
      - APM_ACTIVE=false
      - APM_SERVICE_NAME=rule-901
      # Database
      - RAW_HISTORY_DATABASE=raw_history
      - RAW_HISTORY_DATABASE_HOST=tazama-postgres
      - RAW_HISTORY_DATABASE_PORT=5432
      - RAW_HISTORY_DATABASE_USER=postgres
      - RAW_HISTORY_DATABASE_PASSWORD=postgres
      - CONFIGURATION_DATABASE=configuration
      - CONFIGURATION_DATABASE_HOST=tazama-postgres
      - CONFIGURATION_DATABASE_PORT=5432
      - CONFIGURATION_DATABASE_USER=postgres
      - CONFIGURATION_DATABASE_PASSWORD=postgres
      - EVENT_HISTORY_DATABASE=event_history
      - EVENT_HISTORY_DATABASE_HOST=tazama-postgres
      - EVENT_HISTORY_DATABASE_PORT=5432
      - EVENT_HISTORY_DATABASE_USER=postgres
      - EVENT_HISTORY_DATABASE_PASSWORD=postgres
      # NATS
      - STARTUP_TYPE=nats
      - SERVER_URL=tazama-nats:4222
      - PRODUCER_STREAM=typology-processor
      - CONSUMER_STREAM=rule-901
      - ACK_POLICY=Explicit
      - PRODUCER_STORAGE=File
      - PRODUCER_RETENTION_POLICY=Workqueue
      # Cache
      - LOCAL_CACHETTL=300
      - LOCAL_CACHE_ENABLED=true
      - SIDECAR_HOST=0.0.0.0:5000
    depends_on:
      - postgres
      - nats
      - event-director
    networks:
      - tazama-network

  rule-006:
    build:
      context: ./services/rule-executer
      dockerfile: Dockerfile
      args:
        GH_TOKEN: ${GH_TOKEN}
        RULE_NAME: "006"
        RULE_VERSION: "1.0.0"
    container_name: tazama-rule-006
    environment:
      - FUNCTION_NAME=rule-executer
      - RULE_NAME=006
      - RULE_VERSION=1.0.0
      - NODE_ENV=production
      - MAX_CPU=1
      - APM_ACTIVE=false
      - APM_SERVICE_NAME=rule-006
      # Database
      - RAW_HISTORY_DATABASE=raw_history
      - RAW_HISTORY_DATABASE_HOST=tazama-postgres
      - RAW_HISTORY_DATABASE_PORT=5432
      - RAW_HISTORY_DATABASE_USER=postgres
      - RAW_HISTORY_DATABASE_PASSWORD=postgres
      - CONFIGURATION_DATABASE=configuration
      - CONFIGURATION_DATABASE_HOST=tazama-postgres
      - CONFIGURATION_DATABASE_PORT=5432
      - CONFIGURATION_DATABASE_USER=postgres
      - CONFIGURATION_DATABASE_PASSWORD=postgres
      - EVENT_HISTORY_DATABASE=event_history
      - EVENT_HISTORY_DATABASE_HOST=tazama-postgres
      - EVENT_HISTORY_DATABASE_PORT=5432
      - EVENT_HISTORY_DATABASE_USER=postgres
      - EVENT_HISTORY_DATABASE_PASSWORD=postgres
      # NATS
      - STARTUP_TYPE=nats
      - SERVER_URL=tazama-nats:4222
      - PRODUCER_STREAM=typology-processor
      - CONSUMER_STREAM=rule-006
      - ACK_POLICY=Explicit
      - PRODUCER_STORAGE=File
      - PRODUCER_RETENTION_POLICY=Workqueue
      # Cache
      - LOCAL_CACHETTL=300
      - LOCAL_CACHE_ENABLED=true
      - SIDECAR_HOST=0.0.0.0:5000
    depends_on:
      - postgres
      - nats
      - event-director
    networks:
      - tazama-network

  rule-018:
    build:
      context: ./services/rule-executer
      dockerfile: Dockerfile
      args:
        GH_TOKEN: ${GH_TOKEN}
        RULE_NAME: "018"
        RULE_VERSION: "1.0.0"
    container_name: tazama-rule-018
    environment:
      - FUNCTION_NAME=rule-executer
      - RULE_NAME=018
      - RULE_VERSION=1.0.0
      - NODE_ENV=production
      - MAX_CPU=1
      - APM_ACTIVE=false
      - APM_SERVICE_NAME=rule-018
      # Database
      - RAW_HISTORY_DATABASE=raw_history
      - RAW_HISTORY_DATABASE_HOST=tazama-postgres
      - RAW_HISTORY_DATABASE_PORT=5432
      - RAW_HISTORY_DATABASE_USER=postgres
      - RAW_HISTORY_DATABASE_PASSWORD=postgres
      - CONFIGURATION_DATABASE=configuration
      - CONFIGURATION_DATABASE_HOST=tazama-postgres
      - CONFIGURATION_DATABASE_PORT=5432
      - CONFIGURATION_DATABASE_USER=postgres
      - CONFIGURATION_DATABASE_PASSWORD=postgres
      - EVENT_HISTORY_DATABASE=event_history
      - EVENT_HISTORY_DATABASE_HOST=tazama-postgres
      - EVENT_HISTORY_DATABASE_PORT=5432
      - EVENT_HISTORY_DATABASE_USER=postgres
      - EVENT_HISTORY_DATABASE_PASSWORD=postgres
      # NATS
      - STARTUP_TYPE=nats
      - SERVER_URL=tazama-nats:4222
      - PRODUCER_STREAM=typology-processor
      - CONSUMER_STREAM=rule-018
      - ACK_POLICY=Explicit
      - PRODUCER_STORAGE=File
      - PRODUCER_RETENTION_POLICY=Workqueue
      # Cache
      - LOCAL_CACHETTL=300
      - LOCAL_CACHE_ENABLED=true
      - SIDECAR_HOST=0.0.0.0:5000
    depends_on:
      - postgres
      - nats
      - event-director
    networks:
      - tazama-network

  rule-903:
    build:
      context: ./services/rule-executer
      dockerfile: Dockerfile
      args:
        GH_TOKEN: ${GH_TOKEN}
        RULE_NAME: "903"
        RULE_VERSION: "1.0.0"
    container_name: tazama-rule-903
    environment:
      - FUNCTION_NAME=rule-executer
      - RULE_NAME=903
      - RULE_VERSION=1.0.0
      - NODE_ENV=production
      - MAX_CPU=1
      - APM_ACTIVE=false
      - APM_SERVICE_NAME=rule-903
      # Database
      - RAW_HISTORY_DATABASE=raw_history
      - RAW_HISTORY_DATABASE_HOST=tazama-postgres
      - RAW_HISTORY_DATABASE_PORT=5432
      - RAW_HISTORY_DATABASE_USER=postgres
      - RAW_HISTORY_DATABASE_PASSWORD=postgres
      - CONFIGURATION_DATABASE=configuration
      - CONFIGURATION_DATABASE_HOST=tazama-postgres
      - CONFIGURATION_DATABASE_PORT=5432
      - CONFIGURATION_DATABASE_USER=postgres
      - CONFIGURATION_DATABASE_PASSWORD=postgres
      - EVENT_HISTORY_DATABASE=event_history
      - EVENT_HISTORY_DATABASE_HOST=tazama-postgres
      - EVENT_HISTORY_DATABASE_PORT=5432
      - EVENT_HISTORY_DATABASE_USER=postgres
      - EVENT_HISTORY_DATABASE_PASSWORD=postgres
      # NATS
      - STARTUP_TYPE=nats
      - SERVER_URL=tazama-nats:4222
      - PRODUCER_STREAM=typology-processor
      - CONSUMER_STREAM=rule-903
      - ACK_POLICY=Explicit
      - PRODUCER_STORAGE=File
      - PRODUCER_RETENTION_POLICY=Workqueue
      # Cache
      - LOCAL_CACHETTL=300
      - LOCAL_CACHE_ENABLED=true
      - SIDECAR_HOST=0.0.0.0:5000
    depends_on:
      - postgres
      - nats
      - event-director
    networks:
      - tazama-network

  rule-902:
    build:
      context: ./services/rule-executer
      dockerfile: Dockerfile
      args:
        GH_TOKEN: ${GH_TOKEN}
        RULE_NAME: "902"
        RULE_VERSION: "1.0.0"
    container_name: tazama-rule-902
    environment:
      - FUNCTION_NAME=rule-executer
      - RULE_NAME=902
      - RULE_VERSION=1.0.0
      - NODE_ENV=production
      - MAX_CPU=1
      - APM_ACTIVE=false
      - APM_SERVICE_NAME=rule-902
      # Database
      - RAW_HISTORY_DATABASE=raw_history
      - RAW_HISTORY_DATABASE_HOST=tazama-postgres
      - RAW_HISTORY_DATABASE_PORT=5432
      - RAW_HISTORY_DATABASE_USER=postgres
      - RAW_HISTORY_DATABASE_PASSWORD=postgres
      - CONFIGURATION_DATABASE=configuration
      - CONFIGURATION_DATABASE_HOST=tazama-postgres
      - CONFIGURATION_DATABASE_PORT=5432
      - CONFIGURATION_DATABASE_USER=postgres
      - CONFIGURATION_DATABASE_PASSWORD=postgres
      - EVENT_HISTORY_DATABASE=event_history
      - EVENT_HISTORY_DATABASE_HOST=tazama-postgres
      - EVENT_HISTORY_DATABASE_PORT=5432
      - EVENT_HISTORY_DATABASE_USER=postgres
      - EVENT_HISTORY_DATABASE_PASSWORD=postgres
      # NATS
      - STARTUP_TYPE=nats
      - SERVER_URL=tazama-nats:4222
      - PRODUCER_STREAM=typology-processor
      - CONSUMER_STREAM=rule-902
      - ACK_POLICY=Explicit
      - PRODUCER_STORAGE=File
      - PRODUCER_RETENTION_POLICY=Workqueue
      # Cache
      - LOCAL_CACHETTL=300
      - LOCAL_CACHE_ENABLED=true
      - SIDECAR_HOST=0.0.0.0:5000
    depends_on:
      - postgres
      - nats
      - event-director
    networks:
      - tazama-network

  event-flow:
    build:
      context: ./services/event-flow
      dockerfile: Dockerfile
      args:
        GH_TOKEN: ${GH_TOKEN}
    container_name: tazama-event-flow
    environment:
      - FUNCTION_NAME=event-flow
      - NODE_ENV=production
      - MAX_CPU=1
      - APM_ACTIVE=false
      - APM_SERVICE_NAME=event-flow
      - SUPPRESS_ALERTS=false
      - INTERDICTION_PRODUCER=relay-service
      - INTERDICTION_DESTINATION=relay-service
      # Database
      - CONFIGURATION_DATABASE=configuration
      - CONFIGURATION_DATABASE_HOST=tazama-postgres
      - CONFIGURATION_DATABASE_PORT=5432
      - CONFIGURATION_DATABASE_USER=postgres
      - CONFIGURATION_DATABASE_PASSWORD=postgres
      - EVENT_HISTORY_DATABASE=event_history
      - EVENT_HISTORY_DATABASE_HOST=tazama-postgres
      - EVENT_HISTORY_DATABASE_PORT=5432
      - EVENT_HISTORY_DATABASE_USER=postgres
      - EVENT_HISTORY_DATABASE_PASSWORD=postgres
      # Redis
      - REDIS_DATABASE=0
      - REDIS_SERVERS=[{"host":"tazama-valkey","port":6379}]
      - REDIS_IS_CLUSTER=false
      - REDIS_AUTH=none
      - DISTRIBUTED_CACHETTL=300
      - DISTRIBUTED_CACHE_ENABLED=true
      # NATS
      - STARTUP_TYPE=nats
      - SERVER_URL=tazama-nats:4222
      - PRODUCER_STREAM=event-flow-output
      - CONSUMER_STREAM=event-flow
      - ACK_POLICY=Explicit
      - PRODUCER_STORAGE=File
      - PRODUCER_RETENTION_POLICY=Workqueue
      # Cache
      - LOCAL_CACHETTL=300
      - LOCAL_CACHE_ENABLED=true
      - SIDECAR_HOST=0.0.0.0:5000
    depends_on:
      - postgres
      - nats
      - event-director
    networks:
      - tazama-network

  typology-processor:
    build:
      context: ./services/typology-processor
      dockerfile: Dockerfile
      args:
        GH_TOKEN: ${GH_TOKEN}
    container_name: tazama-typology-processor
    environment:
      - FUNCTION_NAME=typology-processor
      - NODE_ENV=production
      - MAX_CPU=1
      - APM_ACTIVE=false
      - APM_SERVICE_NAME=typology-processor
      - INTERDICTION_DESTINATION=relay-service
      - INTERDICTION_PRODUCER=relay-service
      - INTERDICTION_ENDPOINT=http://tazama-relay-service:3000
      - SUPPRESS_ALERTS=false
      # Database
      - CONFIGURATION_DATABASE=configuration
      - CONFIGURATION_DATABASE_HOST=tazama-postgres
      - CONFIGURATION_DATABASE_PORT=5432
      - CONFIGURATION_DATABASE_USER=postgres
      - CONFIGURATION_DATABASE_PASSWORD=postgres
      # Redis
      - REDIS_DATABASE=0
      - REDIS_SERVERS=[{"host":"tazama-valkey","port":6379}]
      - REDIS_IS_CLUSTER=false
      - REDIS_AUTH=none
      - DISTRIBUTED_CACHETTL=300
      - DISTRIBUTED_CACHE_ENABLED=true
      # NATS
      - STARTUP_TYPE=nats
      - SERVER_URL=tazama-nats:4222
      - PRODUCER_STREAM=tadp
      - CONSUMER_STREAM=typology-processor
      - ACK_POLICY=Explicit
      - PRODUCER_STORAGE=File
      - PRODUCER_RETENTION_POLICY=Workqueue
      # Cache
      - LOCAL_CACHETTL=300
      - LOCAL_CACHE_ENABLED=true
      - SIDECAR_HOST=0.0.0.0:5000
    depends_on:
      - postgres
      - nats
      - valkey
    networks:
      - tazama-network

  tadp:
    build:
      context: ./services/transaction-aggregation-decisioning-processor
      dockerfile: Dockerfile
      args:
        GH_TOKEN: ${GH_TOKEN}
    container_name: tazama-tadp
    environment:
      - FUNCTION_NAME=tadp
      - NODE_ENV=production
      - MAX_CPU=1
      - APM_ACTIVE=false
      - APM_SERVICE_NAME=tadp
      - ALERT_PRODUCER=relay-service
      - ALERT_DESTINATION=relay-service
      - INTERDICTION_PRODUCER=relay-service
      - INTERDICTION_DESTINATION=relay-service
      - SUPPRESS_ALERTS=false
      # Database
      - CONFIGURATION_DATABASE=configuration
      - CONFIGURATION_DATABASE_HOST=tazama-postgres
      - CONFIGURATION_DATABASE_PORT=5432
      - CONFIGURATION_DATABASE_USER=postgres
      - CONFIGURATION_DATABASE_PASSWORD=postgres
      - EVENT_HISTORY_DATABASE=event_history
      - EVENT_HISTORY_DATABASE_HOST=tazama-postgres
      - EVENT_HISTORY_DATABASE_PORT=5432
      - EVENT_HISTORY_DATABASE_USER=postgres
      - EVENT_HISTORY_DATABASE_PASSWORD=postgres
      - EVALUATION_DATABASE=evaluation
      - EVALUATION_DATABASE_HOST=tazama-postgres
      - EVALUATION_DATABASE_PORT=5432
      - EVALUATION_DATABASE_USER=postgres
      - EVALUATION_DATABASE_PASSWORD=postgres
      # Redis
      - REDIS_DATABASE=0
      - REDIS_SERVERS=[{"host":"tazama-valkey","port":6379}]
      - REDIS_IS_CLUSTER=false
      - REDIS_AUTH=none
      - DISTRIBUTED_CACHETTL=300
      - DISTRIBUTED_CACHE_ENABLED=true
      # NATS
      - STARTUP_TYPE=nats
      - SERVER_URL=tazama-nats:4222
      - PRODUCER_STREAM=relay-service # Updated to match Relay Service target
      - CONSUMER_STREAM=tadp # Aligning with Rule Output stream
      - STREAM_SUBJECT=">" # Quoted wildcard to pick up all rule results
      - ACK_POLICY=Explicit
      - PRODUCER_STORAGE=File
      - PRODUCER_RETENTION_POLICY=Interest # Modified to support Multi-Relay (Fan-Out) so REST & Kafka receive same messages
      # Cache
      - LOCAL_CACHETTL=300
      - LOCAL_CACHE_ENABLED=true
      - SIDECAR_HOST=0.0.0.0:5000
    depends_on:
      - postgres
      - nats
      - valkey
    networks:
      - tazama-network

  relay-service:
    # Build from source with locally cloned nats-relay-plugin
    build:
      context: .
      dockerfile: ./services/relay-service/Dockerfile
      args:
        GH_TOKEN: ${GH_TOKEN}
    container_name: tazama-relay-service
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - GH_TOKEN=${GH_TOKEN}
      - STARTUP_TYPE=nats
      - NODE_ENV=dev
      - MAX_CPU=4
      - SERVER_URL=tazama-nats:4222
      - FUNCTION_NAME=messageRelayService
      - CONSUMER_STREAM=relay-service
      - PRODUCER_STREAM=tazama.evaluation.result
      - OUTPUT_TO_JSON=true
      - DESTINATION_TRANSPORT_TYPE=@tazama-lf/nats-relay-plugin
      - DESTINATION_TRANSPORT_URL=tazama-nats:4222
      - APM_ACTIVE=false
      - APM_SERVICE_NAME=relay-service
      - LOGSTASH_LEVEL=info
      - SIDECAR_HOST=0.0.0.0:5000
    depends_on:
      - nats
    networks:
      - tazama-network

  # ==========================================================================
  # KAFKA RELAY SERVICE - Publishes to Kafka topic
  # ==========================================================================
  relay-service-kafka:
    build:
      context: .
      dockerfile: ./services/relay-service-kafka/Dockerfile
      args:
        GH_TOKEN: ${GH_TOKEN}
    container_name: tazama-relay-kafka
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - GH_TOKEN=${GH_TOKEN}
      - STARTUP_TYPE=nats
      - NODE_ENV=dev
      - MAX_CPU=2
      - SERVER_URL=tazama-nats:4222
      - FUNCTION_NAME=messageRelayServiceKafka
      - CONSUMER_STREAM=relay-service
      - PRODUCER_STREAM=tazama.evaluation.result
      - OUTPUT_TO_JSON=true
      - DESTINATION_TRANSPORT_TYPE=@tazama-lf/kafka-relay-plugin
      # Kafka configuration
      - KAFKA_CLIENT_ID=tazama-relay-kafka
      - KAFKA_DESTINATION_TRANSPORT_URL=tazama-kafka:9092
      - KAFKA_PRODUCER_STREAM=tazama.evaluation.result
      - KAFKA_MAX_IN_FLIGHT_REQUESTS=5
      - APM_ACTIVE=false
      - APM_SERVICE_NAME=relay-service-kafka
      - APM_URL=http://apm-server:8200/
      - APM_SECRET_TOKEN=
      - LOGSTASH_LEVEL=info
      - SIDECAR_HOST=0.0.0.0:5000
    depends_on:
      - nats
      - kafka
    networks:
      - tazama-network

  # ==========================================================================
  # REST RELAY SERVICE - Pushes to transfer-service callback endpoint
  # ==========================================================================
  relay-service-rest:
    build:
      context: .
      dockerfile: ./services/relay-service-rest/Dockerfile
      args:
        GH_TOKEN: ${GH_TOKEN}
    container_name: tazama-relay-rest
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - GH_TOKEN=${GH_TOKEN}
      - STARTUP_TYPE=nats
      - NODE_ENV=dev
      - MAX_CPU=2
      - SERVER_URL=tazama-nats:4222
      - FUNCTION_NAME=messageRelayServiceRest
      - CONSUMER_STREAM=relay-service
      - PRODUCER_STREAM=tazama.evaluation.result
      - OUTPUT_TO_JSON=true
      - DESTINATION_TRANSPORT_TYPE=@tazama-lf/rest-relay-plugin
      # REST configuration (push to transfer-service)
      - DESTINATION_TRANSPORT_URL=http://host.docker.internal:8080/transfer/v1/fds/callback
      - AUTH_HEALTH_URL=http://host.docker.internal:8080/transfer/v1/health
      - AUTH_TOKEN_URL=http://host.docker.internal:8080/transfer/v1/fds/auth/token
      - AUTH_USERNAME=relay-service
      - AUTH_PASSWORD=relay-service-secret
      - MAX_SOCKETS=50
      - RETRY_ATTEMPTS=3
      - APM_ACTIVE=false
      - APM_SERVICE_NAME=relay-service-rest
      - APM_URL=http://apm-server:8200/
      - APM_SECRET_TOKEN=
      - LOGSTASH_LEVEL=info
      - SIDECAR_HOST=0.0.0.0:5000
    depends_on:
      - nats
    networks:
      - tazama-network

  # ==========================================================================
  # KAFKA INFRASTRUCTURE (for relay-service-kafka)
  # ==========================================================================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: tazama-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - tazama-network

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: tazama-kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: tazama-zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://tazama-kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    networks:
      - tazama-network

networks:
  tazama-network:
    driver: bridge

volumes:
  postgres-data:


